{% extends "base.html" %}

{% block content %}
<section class="card">
    <div class="detail-header">
        <div>
            <h2>Admin Dashboard</h2>
            <p class="subtitle">Review and update submitted risks.</p>
        </div>
        <div class="button-row">
            {% if enable_admin_import %}
                <form method="post" action="/admin/import">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
                    <button type="submit">Import Risk Register</button>
                </form>
            {% endif %}
            <form method="post" action="{{ url_for('admin_archive_closed_attachments') }}">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="days" value="{{ config.get('ATTACHMENT_ARCHIVE_AFTER_DAYS', 180) }}" />
                <button type="submit" class="button secondary" title="Moves attachments for Closed risks older than the cutoff into archive storage.">Archive old attachments</button>
            </form>
            <a class="button secondary" href="{{ url_for('admin_export', status=status_filter, severity=severity_filter, assigned=assignee_filter, q=query_text) }}">Exports</a>
            <a class="button secondary" href="{{ url_for('admin_tasks') }}">Tasks</a>
            <a class="button secondary" href="{{ url_for('admin_deleted') }}">Deleted</a>
            <a class="button secondary" href="{{ url_for('admin_heatmap') }}">Heatmap</a>
            <a class="button secondary" href="{{ url_for('admin_trends') }}">Trends</a>
            <a class="button" href="{{ url_for('logout') }}">Sign out</a>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="section-block saved-views">
            <div class="section-title">
                <h3>Saved Views</h3>
                <p class="subtitle">Save filter presets for quick access (stored in this browser).</p>
            </div>
            <div class="saved-views-controls">
                <input type="text" id="sv-name" placeholder="Name this view (e.g., My queue)" />
                <button type="button" class="button secondary" id="sv-save">Save current view</button>
                <button type="button" class="button secondary" id="sv-clear" title="Remove all saved views">Clear</button>
            </div>
            <div class="saved-views-list" id="sv-list"></div>
        </div>

        <div class="section-block">
            <div class="section-title">
                <h3>Queue</h3>
                <p class="subtitle">Quick counts for triage and workload.</p>
            </div>
            <div class="summary-grid">
                {% for label, count in queue_cards.items() %}
                    <a class="summary-card link" data-kind="{{ label|lower|replace('/', '-')|replace(' ', '-') }}" href="{{ queue_links.get(label) or '#' }}">
                        <span class="label">{{ label }}</span>
                        <strong>{{ count }}</strong>
                    </a>
                {% endfor %}
            </div>
        </div>

        <div class="section-block">
            <div class="section-title">
                <h3>SLA</h3>
                <p class="subtitle">Measured from the audit trail (risk events).</p>
            </div>
            <div class="summary-grid">
                {% for label, value in sla_cards.items() %}
                    <div class="summary-card" data-kind="{{ label|lower|replace(' ', '-') }}">
                        <span class="label">{{ label }}</span>
                        <strong>{{ value }}</strong>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="section-block">
            <div class="section-title">
                <h3>Overview</h3>
                <p class="subtitle">Live status totals across submitted risks.</p>
            </div>
            <div class="summary-grid">
                {% for item in summary %}
                    <div class="summary-card">
                        <span class="label">{{ item['status'] }}</span>
                        <strong>{{ item['count'] }}</strong>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="section-block">
            <div class="section-title">
                <h3>Severity</h3>
                <p class="subtitle">Distribution across current risks.</p>
            </div>
            <div class="summary-grid">
                {% for item in severity_summary %}
                    <div class="summary-card">
                        <span class="label">{{ item['severity'] }}</span>
                        <strong>{{ item['count'] }}</strong>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="badge-legend" aria-label="Legend" style="margin-top: 10px;">
        <span class="badge status">Status</span>
        <span class="badge severity low">Low</span>
        <span class="badge severity medium">Medium</span>
        <span class="badge severity high">High</span>
        <span class="badge severity critical">Critical</span>
    </div>

    <details class="details">
        <summary>Key performance indicators</summary>
        <p class="subtitle">Operational KPIs for the risk program.</p>
        {% if kpi_cards %}
            <div class="kpi-grid">
                {% for kpi in kpi_cards %}
                    <div class="kpi-card">
                        <span class="label">{{ kpi['name'] }}</span>
                        <strong>{{ kpi['value'] or '—' }}</strong>
                        {% if kpi.get('notes') %}
                            <small class="kpi-muted">{{ kpi['notes'] }}</small>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <p class="kpi-footnote">KPIs are calculated from risk data and update automatically.</p>
        {% else %}
            <div class="empty">No KPI metrics are available yet.</div>
        {% endif %}
    </details>

    <form class="bulk-actions" method="post" action="{{ url_for('admin_bulk_update') }}">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="return_to" value="{{ request.full_path }}" />
        <div class="sticky-bar" aria-label="Dashboard actions">
            <details class="details" id="admin-columns" open>
                <summary>Columns</summary>
                <p class="subtitle">Show/hide fields for a denser triage view (stored in this browser).</p>
                <div class="chips" style="margin-bottom: 10px;">
                    <button type="button" class="button secondary small" data-col-preset="default">Default</button>
                    <button type="button" class="button secondary small" data-col-preset="triage">Triage</button>
                    <button type="button" class="button secondary small" data-col-preset="minimal">Minimal</button>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));">
                    <label><input type="checkbox" data-col-toggle="severity" checked /> Severity</label>
                    <label><input type="checkbox" data-col-toggle="status" checked /> Status</label>
                    <label><input type="checkbox" data-col-toggle="assigned" checked /> Assigned</label>
                    <label><input type="checkbox" data-col-toggle="owner" checked /> Owner</label>
                    <label><input type="checkbox" data-col-toggle="priority" checked /> Priority</label>
                    <label><input type="checkbox" data-col-toggle="progress" checked /> Progress</label>
                    <label><input type="checkbox" data-col-toggle="identified" checked /> Identified</label>
                    <label><input type="checkbox" data-col-toggle="updated" checked /> Updated</label>
                </div>
            </details>

            <div class="bulk-row" aria-label="Bulk update">
                <label>
                    Bulk Status
                    <select name="bulk_status">
                        <option value="">No change</option>
                        {% for option in ['New', 'In Review', 'In Progress', 'Postponed', 'Mitigated', 'Archived', 'Closed'] %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    Bulk Severity
                    <select name="bulk_severity">
                        <option value="">No change</option>
                        {% for sev in severities %}
                            <option value="{{ sev }}">{{ sev }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    Bulk Assignee
                    <input type="email" name="bulk_assigned_to" placeholder="name@hdh.org" autocomplete="email" inputmode="email" list="assignee-options" />
                </label>
                <label class="bulk-inline">
                    <span>Clear assignee</span>
                    <input type="checkbox" name="bulk_clear_assigned_to" value="1" />
                </label>
                <label>
                    Bulk Close Reason
                    <input type="text" name="bulk_close_reason" placeholder="Required if setting Closed" />
                </label>
                <div class="bulk-cta">
                    <div class="bulk-count"><span id="selected-count">0</span> selected</div>
                    <button type="submit" id="bulk-apply" disabled>Apply to selected</button>
                </div>
            </div>
        </div>

        <datalist id="assignee-options">
            {% for a in assignees %}
                <option value="{{ a }}"></option>
            {% endfor %}
        </datalist>

        <div class="table-wrap admin-dashboard-table" id="admin-dashboard-table" aria-label="Admin risk review list">
            <div class="table">
            <div class="table-row table-header admin-list">
                <div class="select-cell" data-col="select">
                    <input type="checkbox" id="select-all" title="Select all" />
                </div>
                <div data-col="title">Title</div>
                <div data-col="severity">Severity</div>
                <div data-col="status">Status</div>
                <div data-col="assigned">Assigned</div>
                <div data-col="owner">Owner</div>
                <div data-col="priority">Priority</div>
                <div data-col="progress">Progress</div>
                <div data-col="identified">Identified</div>
                <div data-col="updated">Updated</div>
            </div>
            {% for risk in risks %}
                <div class="table-row admin-list">
                    <div class="select-cell" data-col="select">
                        <input type="checkbox" name="risk_id" value="{{ risk['id'] }}" class="row-select" />
                    </div>
                    <div class="title" data-col="title">
                        <a href="{{ url_for('admin_risk_detail', risk_id=risk['id']) }}" title="{{ risk['title'] }}">{{ risk['title'] }}</a>
                    </div>
                    <div data-col="severity">
                        <span class="badge severity {{ (risk['severity'] or 'unspecified')|lower }}">{{ risk['severity'] or 'Unspecified' }}</span>
                    </div>
                    <div data-col="status">
                        <span class="badge status">{{ risk['status'] }}</span>
                    </div>
                    <div data-col="assigned" title="{{ risk['assigned_to'] or '' }}">{{ risk['assigned_to'] or '—' }}</div>
                    <div data-col="owner" title="{{ risk['owner'] or '' }}">{{ risk['owner'] or 'Unassigned' }}</div>
                    <div data-col="priority">{{ risk['priority'] or '—' }}</div>
                    <div data-col="progress">
                        <progress class="progress" value="{{ risk['progress'] or 0 }}" max="100"></progress>
                        <small>{{ risk['progress'] }}%</small>
                    </div>
                    <div data-col="identified">{{ (risk['date_identified'] or '')[:10] }}</div>
                    <div data-col="updated">{{ risk['updated_at'][:10] }}</div>
                </div>
            {% else %}
                <div class="empty">No risks to review.</div>
            {% endfor %}
            </div>
        </div>
    </form>

    <div class="pager" aria-label="Pagination">
        <div class="pager-left">
            <span class="muted">Showing page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total }} total)</span>
        </div>
        <div class="pager-right">
            {% if pagination.has_prev %}
                <a class="button secondary" href="{{ pagination.prev_url }}">Previous</a>
            {% endif %}
            {% if pagination.has_next %}
                <a class="button secondary" href="{{ pagination.next_url }}">Next</a>
            {% endif %}
        </div>
    </div>

    <script>
        (function () {
            const selectAll = document.getElementById('select-all');
            const rows = Array.from(document.querySelectorAll('input.row-select'));
            const selectedCount = document.getElementById('selected-count');
            const bulkApply = document.getElementById('bulk-apply');

            const storageKey = 'risk_admin_saved_views_v1';
            const svName = document.getElementById('sv-name');
            const svSave = document.getElementById('sv-save');
            const svClear = document.getElementById('sv-clear');
            const svList = document.getElementById('sv-list');

            function currentViewPath() {
                const url = new URL(window.location.href);
                url.searchParams.delete('page');
                const qs = url.searchParams.toString();
                return url.pathname + (qs ? ('?' + qs) : '');
            }

            function loadViews() {
                try {
                    const raw = localStorage.getItem(storageKey);
                    const data = raw ? JSON.parse(raw) : [];
                    return Array.isArray(data) ? data : [];
                } catch (e) {
                    return [];
                }
            }

            function saveViews(views) {
                try {
                    localStorage.setItem(storageKey, JSON.stringify(views));
                } catch (e) {
                    // ignore
                }
            }

            function renderViews() {
                if (!svList) return;
                svList.innerHTML = '';
                const views = loadViews();
                if (!views.length) {
                    const empty = document.createElement('div');
                    empty.className = 'muted';
                    empty.textContent = 'No saved views yet.';
                    svList.appendChild(empty);
                    return;
                }

                views.forEach((v, idx) => {
                    const row = document.createElement('div');
                    row.className = 'saved-view-row';

                    const link = document.createElement('a');
                    link.className = 'saved-view-link';
                    link.href = v.path;
                    link.textContent = v.name;

                    const del = document.createElement('button');
                    del.type = 'button';
                    del.className = 'button secondary saved-view-delete';
                    del.textContent = 'Remove';
                    del.addEventListener('click', () => {
                        const next = loadViews().filter((_, i) => i !== idx);
                        saveViews(next);
                        renderViews();
                    });

                    row.appendChild(link);
                    row.appendChild(del);
                    svList.appendChild(row);
                });
            }

            function updateState() {
                const checked = rows.filter(cb => cb.checked).length;
                if (selectedCount) selectedCount.textContent = String(checked);
                if (bulkApply) bulkApply.disabled = checked === 0;
                if (selectAll) {
                    selectAll.checked = checked > 0 && checked === rows.length;
                    selectAll.indeterminate = checked > 0 && checked < rows.length;
                }
            }

            if (selectAll) {
                selectAll.addEventListener('change', function () {
                    rows.forEach(cb => { cb.checked = selectAll.checked; });
                    updateState();
                });
            }

            rows.forEach(cb => cb.addEventListener('change', updateState));
            updateState();

            renderViews();

            if (svSave && svName) {
                svSave.addEventListener('click', () => {
                    const name = (svName.value || '').trim();
                    if (!name) {
                        svName.focus();
                        return;
                    }
                    const path = currentViewPath();
                    const views = loadViews();
                    const existingIndex = views.findIndex(v => v && v.name && v.name.toLowerCase() === name.toLowerCase());
                    const entry = { name, path };
                    if (existingIndex >= 0) {
                        views[existingIndex] = entry;
                    } else {
                        views.unshift(entry);
                    }
                    saveViews(views.slice(0, 20));
                    svName.value = '';
                    renderViews();
                });
            }

            if (svClear) {
                svClear.addEventListener('click', () => {
                    saveViews([]);
                    renderViews();
                });
            }

            // Column visibility (stored per-browser)
            const tableWrap = document.getElementById('admin-dashboard-table');
            const colRoot = document.getElementById('admin-columns');
            const colKey = 'risk_admin_cols_v1';

            function applyColState(state) {
                if (!tableWrap || !state) return;
                const cols = ['severity', 'status', 'assigned', 'owner', 'priority', 'progress', 'identified', 'updated'];
                cols.forEach(col => {
                    const hide = state[col] === false;
                    tableWrap.classList.toggle('hide-' + col, hide);
                });

                if (colRoot) {
                    cols.forEach(col => {
                        const cb = colRoot.querySelector('input[data-col-toggle="' + col + '"]');
                        if (cb) cb.checked = state[col] !== false;
                    });
                }
            }

            function loadColState() {
                try {
                    const raw = localStorage.getItem(colKey);
                    return raw ? JSON.parse(raw) : null;
                } catch (e) {
                    return null;
                }
            }

            function saveColState(state) {
                try {
                    localStorage.setItem(colKey, JSON.stringify(state));
                } catch (e) {
                    // ignore
                }
            }

            function presetState(kind) {
                const base = {
                    severity: true,
                    status: true,
                    assigned: true,
                    owner: true,
                    priority: true,
                    progress: true,
                    identified: true,
                    updated: true
                };
                if (kind === 'triage') {
                    base.owner = false;
                    base.identified = false;
                    return base;
                }
                if (kind === 'minimal') {
                    base.owner = false;
                    base.priority = false;
                    base.progress = false;
                    base.identified = false;
                    base.updated = false;
                    return base;
                }
                return base;
            }

            const loaded = loadColState();
            applyColState(loaded || presetState('default'));
            if (!loaded) saveColState(presetState('default'));

            if (colRoot) {
                colRoot.querySelectorAll('input[data-col-toggle]').forEach(cb => {
                    cb.addEventListener('change', () => {
                        const state = loadColState() || presetState('default');
                        const col = cb.getAttribute('data-col-toggle');
                        state[col] = cb.checked;
                        saveColState(state);
                        applyColState(state);
                    });
                });

                colRoot.querySelectorAll('button[data-col-preset]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const kind = btn.getAttribute('data-col-preset');
                        const state = presetState(kind);
                        saveColState(state);
                        applyColState(state);
                    });
                });
            }
        })();
    </script>
</section>
{% endblock %}
