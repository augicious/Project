{% extends "base.html" %}

{% block content %}
<section class="card">
    <div class="detail-header">
        <div>
            <h2>Tasks</h2>
            <p class="subtitle">Track work items across all risks.</p>
        </div>
        <div class="button-row">
            <a class="button secondary" href="{{ url_for('admin_dashboard') }}">Back to dashboard</a>
        </div>
    </div>

    <div class="sticky-bar" aria-label="Task filters">
        <form method="get" action="{{ url_for('admin_tasks') }}" class="form" style="margin: 0;">
            <div class="form-grid">
                <label>
                    Status
                    <select name="status">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
                        <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </label>
                <label>
                    Assigned
                    <select name="assigned">
                        <option value="all" {% if assignee_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="me" {% if assignee_filter == 'me' %}selected{% endif %}>Me</option>
                        <option value="unassigned" {% if assignee_filter == 'unassigned' %}selected{% endif %}>Unassigned</option>
                    </select>
                </label>
                <label>
                    Due
                    <select name="due">
                        <option value="all" {% if due_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="overdue" {% if due_filter == 'overdue' %}selected{% endif %}>Overdue</option>
                        <option value="due_7" {% if due_filter == 'due_7' %}selected{% endif %}>Due in 7 days</option>
                        <option value="due_30" {% if due_filter == 'due_30' %}selected{% endif %}>Due in 30 days</option>
                        <option value="no_due" {% if due_filter == 'no_due' %}selected{% endif %}>No due date</option>
                    </select>
                </label>
                <label class="grid-span-full">
                    Search
                    <input type="text" name="q" value="{{ query_text }}" placeholder="Task title, notes, or risk title" />
                </label>
            </div>
            <div class="button-row mt-12">
                <button type="submit">Apply filters</button>
                <a class="button secondary" href="{{ url_for('admin_tasks') }}">Reset</a>
                <span class="muted" style="align-self:center;">{{ tasks|length }} task(s)</span>
            </div>

            {% if status_filter != 'all' or assignee_filter != 'all' or due_filter != 'all' or (query_text|trim) %}
                <div class="chips mt-10" aria-label="Active filters">
                    {% if status_filter != 'all' %}
                        <span class="chip">Status: {{ status_filter }}</span>
                    {% endif %}
                    {% if assignee_filter != 'all' %}
                        <span class="chip">Assigned: {{ assignee_filter }}</span>
                    {% endif %}
                    {% if due_filter != 'all' %}
                        <span class="chip">Due: {{ due_filter }}</span>
                    {% endif %}
                    {% if query_text|trim %}
                        <span class="chip">Search: {{ query_text }}</span>
                    {% endif %}
                    <span class="chip"><a href="{{ url_for('admin_tasks') }}">Clear all <span class="chip-x">×</span></a></span>
                </div>
            {% endif %}
        </form>
    </div>

    <div class="section-block mt-12">
        <div class="section-title">
            <h3>Reminders</h3>
            <p class="subtitle">Email task reminders to assignees for tasks due soon (including overdue).</p>
        </div>
        <form method="post" action="{{ url_for('admin_send_task_reminders') }}" class="form mt-10">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
            <div class="form-grid">
                <label>
                    Days ahead
                    <input type="number" name="days_ahead" min="0" max="60" step="1" value="3" />
                </label>
            </div>
            <div class="button-row mt-10">
                <button type="submit">Send reminders</button>
            </div>
        </form>
    </div>

    <div class="section-block mt-12">
        <div class="section-title">
            <h3>Task list</h3>
            <p class="subtitle">Today: {{ today }}</p>
        </div>

        {% if tasks %}
            <div class="attachment-list">
                {% for t in tasks %}
                    <div class="attachment">
                        <div class="attachment-row" style="align-items:flex-start; gap: 12px;">
                            <div style="min-width: 0;">
                                <div style="font-weight: 700; word-break: break-word;">{{ t['title'] }}</div>
                                <small class="muted">
                                    <a href="{{ url_for('admin_risk_detail', risk_id=t['risk_id']) }}">{{ t['risk_title'] }}</a>
                                    <span> • </span>
                                    <span class="badge">{{ (t['status'] or 'Open')|trim }}</span>
                                    {% if t['due_date'] %}
                                        <span class="badge secondary">Due {{ t['due_date'] }}</span>
                                    {% else %}
                                        <span class="badge secondary">No due date</span>
                                    {% endif %}
                                    {% if t['assigned_to'] %}
                                        <span class="badge secondary">{{ t['assigned_to'] }}</span>
                                    {% else %}
                                        <span class="badge secondary">Unassigned</span>
                                    {% endif %}
                                </small>
                                {% if t['notes'] %}
                                    <div class="muted" style="margin-top: 8px; white-space: pre-wrap;">{{ t['notes'] }}</div>
                                {% endif %}
                            </div>

                            <div style="display:flex; flex-wrap:wrap; gap: 10px; justify-content:flex-end;">
                                <form method="post" action="{{ url_for('admin_task_set_status', task_id=t['id']) }}" style="display:flex; gap: 8px; align-items:center;">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
                                    <select name="status" aria-label="Task status">
                                        {% for option in task_status_options %}
                                            <option value="{{ option }}" {% if (t['status'] or '')|trim == option %}selected{% endif %}>{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="button secondary">Update</button>
                                </form>
                                <form method="post" action="{{ url_for('admin_task_delete', task_id=t['id']) }}" onsubmit="return confirm('Delete this task?');">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
                                    <button type="submit" class="button secondary">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty">No tasks match your filters.</div>
        {% endif %}
    </div>
</section>
{% endblock %}
