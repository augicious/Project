{% extends "base.html" %}

{% block content %}
<section class="card">
    <style>
        .heatmap-toolbar { display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-top: 8px; }
        .heatmap-toolbar .meta { color: var(--muted); font-size: 0.95rem; }
        .heatmap-toolbar label { display:block; font-size: 0.9rem; color: var(--muted); margin-bottom: 4px; }
        .heatmap-toolbar select { min-width: 180px; }

        .hm-table { width: 100%; min-width: 560px; border-collapse: collapse; }
        .hm-table th { text-align: center; padding: 10px 8px; font-weight: 800; border-bottom: 1px solid rgba(226, 232, 240, 0.10); }
        .hm-table th:first-child { text-align: left; }
        .hm-table td { text-align: center; padding: 10px 8px; border-top: 1px solid rgba(226, 232, 240, 0.08); }
        .hm-rowhdr { text-align:left !important; font-weight: 800; }

        .hm-cell { position: relative; border-radius: 8px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.01); }
        .hm-cell:not(.hm-zero) { box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.08); }
        .hm-cell > * { position: relative; }
        .hm-cell::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 8px;
            background: var(--hm-fill, transparent);
            opacity: var(--hm-alpha, 0.0);
            pointer-events: none;
        }
        .hm-count { font-weight: 900; font-size: 1.1rem; }
        .hm-score { font-size: 0.8rem; opacity: 0.85; margin-top: 2px; }
        .hm-zero { opacity: 0.42; }

        /* Baseline (banded) coloring using theme tokens */
        .hm-low { --hm-fill: var(--success); --hm-alpha: 0.14; }
        .hm-medium { --hm-fill: var(--warning); --hm-alpha: 0.16; }

        /* High = orange, Critical = red */
        .hm-high { --hm-fill: linear-gradient(135deg, var(--warning), var(--danger)); --hm-alpha: 0.22; }
        .hm-critical { --hm-fill: var(--danger); --hm-alpha: 0.42; }

        /* Smooth low→critical gradient across the whole map (progressive enhancement) */
        @supports (background: color-mix(in srgb, #000 50%, #fff)) {
            .hm-cell {
                --hm-mid: 0.30; /* start blending toward red early so High reads orange */
                --t: clamp(0, var(--hm-t, 0), 1);
                --sw-mix: clamp(0, calc(var(--t) / var(--hm-mid)), 1);
                --wd-mix: clamp(0, calc((var(--t) - var(--hm-mid)) / (1 - var(--hm-mid))), 1);
                --sw: color-mix(in srgb,
                    var(--success) calc((1 - var(--sw-mix)) * 100%),
                    var(--warning) calc(var(--sw-mix) * 100%)
                );
                --hm-color: color-mix(in srgb,
                    var(--sw) calc((1 - var(--wd-mix)) * 100%),
                    var(--danger) calc(var(--wd-mix) * 100%)
                );

                /* Depth + polish */
                --hm-fill: radial-gradient(120% 120% at 30% 30%, var(--hm-color), transparent 66%);
                /* More contrast across the map: make higher scores visibly “hotter”. */
                --hm-alpha: calc(0.14 + (var(--t) * 0.62));
            }

            /* Keep empty cells clearly subdued even when score is high (they're still empty). */
            .hm-cell.hm-zero {
                --hm-alpha: calc(0.06 + (var(--t) * 0.22));
            }
        }
        .hm-legend { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 6px; }
        .hm-pill { display:inline-flex; gap:8px; align-items:center; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(226, 232, 240, 0.12); color: rgba(226, 232, 240, 0.92); font-size: 0.9rem; }
        .hm-swatch { width: 14px; height: 14px; border-radius: 4px; display:inline-block; }
        .hm-swatch.hm-low { background: var(--success); }
        .hm-swatch.hm-medium { background: var(--warning); }
        .hm-swatch.hm-high { background: linear-gradient(135deg, var(--warning), var(--danger)); }
        .hm-swatch.hm-critical { background: var(--danger); }
    </style>

    <div class="detail-header">
        <div>
            <h2>Risk Heatmap</h2>
            <p class="subtitle">Likelihood × Impact scoring (1–25) using Very Low → Very High. Deleted risks are excluded.</p>
        </div>
        <div class="button-row">
            <a class="button secondary" href="{{ url_for('admin_dashboard') }}">Back to dashboard</a>
            <a class="button secondary" href="{{ url_for('admin_trends') }}">Trends</a>
        </div>
    </div>

    <div class="heatmap-toolbar">
        <form method="get" action="{{ url_for('admin_heatmap') }}" style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div>
                <label for="scope">Scope</label>
                <select id="scope" name="scope">
                    <option value="open" {% if scope != 'all' %}selected{% endif %}>Open only</option>
                    <option value="all" {% if scope == 'all' %}selected{% endif %}>All (including closed)</option>
                </select>
            </div>
            <div>
                <button class="button" type="submit">Apply</button>
            </div>
        </form>

        <div class="meta">
            Included: <strong>{{ included_total }}</strong>
            {% if scope != 'all' %}(open){% else %}(all){% endif %}
            · Excluded deleted: <strong>{{ deleted_excluded }}</strong>
            {% if scope != 'all' %}· Excluded non-open: <strong>{{ nonopen_excluded }}</strong>{% endif %}
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="section-block">
            <div class="section-title">
                <h3>Current banding (Initial)</h3>
                <p class="subtitle">Based on initial likelihood/impact (falls back to legacy likelihood/impact if initial is blank).</p>
            </div>
            <div class="summary-grid">
                {% set band_order = ['Critical','High','Medium','Low','Unscored'] %}
                {% for label in band_order %}
                    <div class="summary-card">
                        <span class="label">{{ label }}</span>
                        <strong>{{ band_counts_initial.get(label, 0) }}</strong>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="section-block">
            <div class="section-title">
                <h3>Current banding (Residual)</h3>
                <p class="subtitle">Based on residual likelihood/impact.</p>
            </div>
            <div class="summary-grid">
                {% set band_order = ['Critical','High','Medium','Low','Unscored'] %}
                {% for label in band_order %}
                    <div class="summary-card">
                        <span class="label">{{ label }}</span>
                        <strong>{{ band_counts_residual.get(label, 0) }}</strong>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="section-block" style="margin-top: 12px;">
        <div class="section-title">
            <h3>Heatmap (Initial)</h3>
            <p class="subtitle">Rows = Likelihood, Columns = Impact. Unscored: {{ initial_unscored }}</p>
            <div class="hm-legend">
                <span class="hm-pill"><span class="hm-swatch hm-low"></span>Low</span>
                <span class="hm-pill"><span class="hm-swatch hm-medium"></span>Medium</span>
                <span class="hm-pill"><span class="hm-swatch hm-high"></span>High</span>
                <span class="hm-pill"><span class="hm-swatch hm-critical"></span>Critical</span>
            </div>
        </div>
        <div style="overflow:auto;">
            <table class="hm-table">
                <thead>
                    <tr>
                        <th style="text-align:left; padding: 8px;">Likelihood \ Impact</th>
                        {% for i in range(1,6) %}
                            <th style="text-align:center; padding: 8px;">{{ levels[i-1] }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for l in range(1,6) %}
                        <tr>
                            <td class="hm-rowhdr">{{ levels[l-1] }}</td>
                            {% for i in range(1,6) %}
                                {% set c = initial_matrix.get((l,i), 0) %}
                                {% set score = l*i %}
                                {% if score <= 3 %}
                                    {% set band_class = 'hm-low' %}
                                    {% set band_label = 'Low' %}
                                {% elif score <= 8 %}
                                    {% set band_class = 'hm-medium' %}
                                    {% set band_label = 'Medium' %}
                                {% elif score <= 12 %}
                                    {% set band_class = 'hm-high' %}
                                    {% set band_label = 'High' %}
                                {% else %}
                                    {% set band_class = 'hm-critical' %}
                                    {% set band_label = 'Critical' %}
                                {% endif %}

                                <td title="Score {{ score }} ({{ band_label }})" class="hm-cell {{ band_class }} {% if c == 0 %}hm-zero{% endif %}" style="--hm-t: {{ '%.4f' % ((score - 1) / 24) }};">
                                    <div class="hm-count">{{ c }}</div>
                                    <div class="hm-score">{{ score }}</div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-block" style="margin-top: 12px;">
        <div class="section-title">
            <h3>Heatmap (Residual)</h3>
            <p class="subtitle">Rows = Likelihood, Columns = Impact. Unscored: {{ residual_unscored }}</p>
            <div class="hm-legend">
                <span class="hm-pill"><span class="hm-swatch hm-low"></span>Low</span>
                <span class="hm-pill"><span class="hm-swatch hm-medium"></span>Medium</span>
                <span class="hm-pill"><span class="hm-swatch hm-high"></span>High</span>
                <span class="hm-pill"><span class="hm-swatch hm-critical"></span>Critical</span>
            </div>
        </div>
        <div style="overflow:auto;">
            <table class="hm-table">
                <thead>
                    <tr>
                        <th style="text-align:left; padding: 8px;">Likelihood \ Impact</th>
                        {% for i in range(1,6) %}
                            <th style="text-align:center; padding: 8px;">{{ levels[i-1] }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for l in range(1,6) %}
                        <tr>
                            <td class="hm-rowhdr">{{ levels[l-1] }}</td>
                            {% for i in range(1,6) %}
                                {% set c = residual_matrix.get((l,i), 0) %}
                                {% set score = l*i %}
                                {% if score <= 3 %}
                                    {% set band_class = 'hm-low' %}
                                    {% set band_label = 'Low' %}
                                {% elif score <= 8 %}
                                    {% set band_class = 'hm-medium' %}
                                    {% set band_label = 'Medium' %}
                                {% elif score <= 12 %}
                                    {% set band_class = 'hm-high' %}
                                    {% set band_label = 'High' %}
                                {% else %}
                                    {% set band_class = 'hm-critical' %}
                                    {% set band_label = 'Critical' %}
                                {% endif %}

                                <td title="Score {{ score }} ({{ band_label }})" class="hm-cell {{ band_class }} {% if c == 0 %}hm-zero{% endif %}" style="--hm-t: {{ '%.4f' % ((score - 1) / 24) }};">
                                    <div class="hm-count">{{ c }}</div>
                                    <div class="hm-score">{{ score }}</div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}
