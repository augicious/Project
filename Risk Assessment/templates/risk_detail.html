{% extends "base.html" %}

{% block content %}
<section class="card">
    <div class="detail-header">
        <div>
            <h2>{{ risk['title'] }}</h2>
            <p class="subtitle">Status: {{ risk['status'] }}</p>
        </div>
        <div class="progress-summary">
            <progress class="progress large" value="{{ risk['progress'] or 0 }}" max="100"></progress>
            <small>{{ risk['progress'] }}% complete</small>
        </div>
    </div>

    <div class="detail-grid">
        <div>
            <h3>Description</h3>
            <p>{{ risk['description'] }}</p>
        </div>
        <div>
            <h3>Priority</h3>
            <p>{{ risk['priority'] or 'Not set' }}</p>
        </div>
        <div>
            <h3>Date Identified</h3>
            <p>{{ risk['date_identified'] or 'Not recorded' }}</p>
        </div>
        <div>
            <h3>Likelihood</h3>
            <p>{{ risk['likelihood'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Impact</h3>
            <p>{{ risk['impact'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Initial Likelihood</h3>
            <p>{{ risk['likelihood_initial'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Initial Impact</h3>
            <p>{{ risk['impact_initial'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Residual Likelihood</h3>
            <p>{{ risk['likelihood_residual'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Residual Impact</h3>
            <p>{{ risk['impact_residual'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Impact Type</h3>
            <p>{{ risk['impact_type'] or 'Not specified' }}</p>
        </div>
        <div>
            <h3>Owner</h3>
            <p>{{ risk['owner'] or 'Unassigned' }}</p>
        </div>
        <div>
            <h3>Mitigation</h3>
            <p>{{ risk['mitigation'] or 'Not yet provided' }}</p>
        </div>
        <div>
            <h3>Mitigation History</h3>
            <p>{{ risk['mitigation_history'] or 'Not available' }}</p>
        </div>
        <div>
            <h3>Admin Notes</h3>
            <p>{{ risk['admin_notes'] or 'No notes yet.' }}</p>
        </div>
        <div>
            <h3>Review Period</h3>
            <p>{{ risk['review_period'] or 'Not set' }}</p>
        </div>
        <div>
            <h3>Date Last Reviewed</h3>
            <p>{{ risk['date_last_reviewed'] or 'Not set' }}</p>
        </div>
        <div>
            <h3>Next Review</h3>
            <p>{{ risk['next_review'] or 'Not set' }}</p>
        </div>
        <div>
            <h3>Date Postponed</h3>
            <p>{{ risk['date_postponed'] or 'Not applicable' }}</p>
        </div>
        <div>
            <h3>Reason Postponed</h3>
            <p>{{ risk['reason_postponed'] or 'Not applicable' }}</p>
        </div>
        <div>
            <h3>Date Mitigated</h3>
            <p>{{ risk['date_mitigated'] or 'Not applicable' }}</p>
        </div>
        <div>
            <h3>Source Sheet</h3>
            <p>{{ risk['source_sheet'] or 'Manual entry' }}</p>
        </div>
    </div>

    <div class="section-block">
        <div class="section-title">
            <h3>Attachments</h3>
            <p class="subtitle">Files uploaded by admins for this risk.</p>
        </div>
        {% if attachments %}
            <div class="attachment-list">
                {% for a in attachments %}
                    <div class="attachment">
                        <div class="attachment-row">
                            <a href="{{ url_for('risk_attachment_download', risk_id=risk['id'], attachment_id=a['id']) }}">{{ a['original_name'] }}</a>
                            {% if a['is_archived'] %}
                                <span class="badge secondary">Archived</span>
                            {% endif %}
                        </div>
                        <small class="muted">{{ (a['size_bytes'] or 0) // 1024 }} KB • {{ (a['created_at'] or '')[:19].replace('T', ' ') }}</small>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty">No attachments yet.</div>
        {% endif %}
    </div>

    <details class="details" id="audit-trail">
        <summary>Audit Trail ({{ events_pagination.total }})</summary>
        <p class="subtitle">Recent changes to status, severity, assignment, and progress.</p>

        {% if events %}
            <div class="event-list">
                {% for ev in events %}
                    <div class="event">
                        <div class="event-meta">
                            <span class="badge">{{ ev['event_type'] }}</span>
                            <span class="event-actor">{{ ev['actor'] or 'system' }}</span>
                            <span class="event-time">{{ ev['created_at'][:19].replace('T', ' ') }}</span>
                        </div>
                        {% if ev['field'] %}
                            <div class="event-body">
                                <strong>{{ ev['field'] }}</strong>
                                <span class="event-diff">{{ ev['old_value'] or '—' }} → {{ ev['new_value'] or '—' }}</span>
                            </div>
                        {% else %}
                            <div class="event-body">
                                <span class="event-diff">Created</span>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            {% if events_pagination.pages > 1 %}
                <div class="pager" aria-label="Audit trail pagination" style="margin-top: 12px;">
                    <div class="pager-left">
                        <span class="muted">Showing page {{ events_pagination.page }} of {{ events_pagination.pages }} ({{ events_pagination.total }} total)</span>
                    </div>
                    <div class="pager-right">
                        {% if events_pagination.has_prev %}
                            <a class="button secondary" href="{{ events_pagination.prev_url }}#audit-trail">Previous</a>
                        {% endif %}
                        {% if events_pagination.has_next %}
                            <a class="button secondary" href="{{ events_pagination.next_url }}#audit-trail">Next</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="empty">No activity recorded yet.</div>
        {% endif %}
    </details>

    <div class="meta">
        <span>Created: {{ risk['created_at'][:10] }}</span>
        <span>Updated: {{ risk['updated_at'][:10] }}</span>
    </div>

    <script>
        (function () {
            if (window.location.hash !== '#audit-trail') {
                return;
            }
            const el = document.getElementById('audit-trail');
            if (!el) {
                return;
            }
            if (el.tagName && el.tagName.toLowerCase() === 'details') {
                el.open = true;
            }
            try {
                el.scrollIntoView({ block: 'start', behavior: 'smooth' });
            } catch (e) {
                // ignore
            }
        })();
    </script>
</section>
{% endblock %}
